<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GDP Rate of Countries</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="navbar.css" />
  <style>
    h2 {
      text-align: center;
      font-family: 'Roboto', sans-serif;
    }

    .content-main{
      margin-top:75px;
      text-align: center;
      font-family: 'Nunito', sans-serif; /* Applying Nunito font family */
    }

    .content-main p {
      margin-bottom: -25px; 
    }

    .red-cursive {
      color: red; /* Setting text color to red */
      font-style: italic; /* Applying italic font style */
      font-family: cursive; /* Applying cursive font family */
      font-size: 16px;
    }

    /* New CSS styles to ensure text labels have a higher z-index */
    .node text {
      pointer-events: none;
      z-index: 1; /* Ensure text labels are above tooltip */
    }

    .node:hover text {
      pointer-events: auto;
    }

    text {
      font-size: 14px;
      font-family: 'Roboto', sans-serif;
      font-weight: bold;
    }
    #slider-container {
      text-align: center;
      margin-bottom: 20px;
      margin-top:75px;
    }
    #slider {
      width: 500px;
      height: 20px;
      background-color: #ddd;
      outline: none;
      opacity: 0.7;
      -webkit-transition: 0.2s;
      transition: opacity 0.2s;
    }
    #slider:hover {
      opacity: 1;
    }
    #slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background-color: #4caf50;
      cursor: pointer;
    }
    #slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background-color: #4caf50;
      cursor: pointer;
    }
    #chart-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 80vh;
    }
    #chart {
      border: 2px solid black; /* Add border around the chart */
  margin-right: 22px;
    }
    #legend-container {
      width: 200px;
      
    }
    #legend {
      
    }
    #legend svg {
      /* Adjust the height of the legend */
    }
    .legend-item:hover {
      cursor: pointer;
      fill-opacity: 0.8; /* Adjust opacity on hover */
    }
    .legend-tooltip {
      position: absolute;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      pointer-events: none; /* Ensure tooltips don't interfere with hover events */
      display: none; /* Initially hide tooltip */
      font-family: 'Roboto', sans-serif;
      font-size: 12px;
    }
  </style>
</head>
<body>
  
  <header>
    <nav>
      <a href="home.html" class="logo">Migration</a>
      <div class="nav-links">
        <a href="try1.html">Doctor Migration Heatmap</a>
        <a href="tree.html">GDP</a>
      </div>
    </nav>
  </header>

  <div class="content-main">
    <h2>Understanding Global Economic Trends: GDP Rates of Countries with Treemap Chart</h2>
    <p><b>Explore the economic landscapes of nations across the globe through our interactive treemap visualization of Gross Domestic Product (GDP) rates.</b></p>
    <br>
    <p><b>As a complement to our primary visualisation on doctor migration patterns, this treemap offers invaluable insights into how economic conditions influence the movement of healthcare professionals across borders 
      and it uses the same color scale as used in the heatmap for better comparison</b></p>
    <br>
    <p class="red-cursive"><b>How to Use</b></p>
    <br>
    <p class="red-cursive"><b>Year Navigation:</b> Utilise the slider to seamlessly navigate through different years and observe the evolving GDP rates of countries.</p>
    <br>
    <p class="red-cursive"><b>Hover Interactivity:</b> Hover over any country to reveal detailed information about its GDP per capita, providing valuable insights into its economic status and growth trajectory.</p>
  </div>

  <div id="slider-container">
    <input type="range" id="slider" min="2010" max="2022" step="1" value="2010" />
    <span style="font-size: 18px; font-family: arial, sans-serif; font-weight: bold;">Year: <span id="year-label">2010</span></span>
  </div>
  <div id="chart-container">
    <div id="chart"></div>
    <div id="legend-container">
      <div id="legend"></div>
    </div>
  </div>
  <div class="legend-tooltip"></div>

  <script>
   const width = 850;
const height = 550;
const treemap = d3.treemap().size([width, height]).paddingInner(1);
const svg = d3.select('#chart').append('svg').attr('width', width).attr('height', height);
const legendSvg = d3.select('#legend').append('svg').attr('width', 200).attr('height', 600); // Adjust the width and height as needed

let nodes;
let colorScale;
let data;

d3.csv('gdp.csv').then((csvData) => {
  data = csvData;
  const allGdpValues = data.map(d => +d['GDP per capita']);
  const overallMinGDP = d3.min(allGdpValues);
  const overallMaxGDP = d3.max(allGdpValues);

  // Define custom thresholds for the legend based on the overall data
  const thresholds = d3.range(overallMinGDP, overallMaxGDP, (overallMaxGDP - overallMinGDP) / 5);

  // Create a threshold scale and reverse the color range
  colorScale = d3.scaleThreshold()
    .domain(thresholds)
    .range(d3.schemeRdYlBu[6].reverse()); // Reverse the color scheme

  updateTreemap('2010'); // Initial render

  const slider = document.getElementById('slider');
  const yearLabel = document.getElementById('year-label');

  slider.addEventListener('input', function () {
    const year = this.value;
    yearLabel.textContent = year;
    updateTreemap(year);
  });

  function updateTreemap(year) {
    const newData = data.filter(d => d.Year == year);
    const root = d3.hierarchy({ children: newData }).sum(d => +d['GDP per capita']).sort((a, b) => b.value - a.value);
    treemap(root);

    if (nodes) nodes.remove(); // Remove previous nodes

    // Remove previous nodes and labels
svg.selectAll('.node').remove();
svg.selectAll('.country-label').remove();

// Create new nodes and labels
nodes = svg.selectAll('.node')
  .data(root.descendants())
  .enter()
  .append('g')
  .attr('class', 'node')
  .attr('transform', d => `translate(${d.x0},${d.y0})`);

nodes
  .append('rect')
  .attr('width', d => d.x1 - d.x0)
  .attr('height', d => d.y1 - d.y0)
  .attr('fill', d => d.children ? 'none' : colorScale(d.data['GDP per capita']))
  .attr('class', d => d.children ? null : 'node--leaf')
  .on('mouseover', showTooltip)
  .on('mousemove', moveTooltip)
  .on('mouseleave', hideTooltip);

// Append text elements for country names
nodes.append('text')
  .attr('x', 3)
  .attr('y', 13)
  .text(d => d.data.Entity ? d.data.Entity : 'Unknown')
  .attr('class', 'country-label');

  updateLegend(overallMinGDP, overallMaxGDP); // Update legend with overall min and max GDP values

    // Remove previous country labels
  svg.selectAll('.country-label').remove();

  // Append text elements for country names directly to the SVG container
  svg.selectAll('.country-label')
    .data(root.descendants())
    .enter()
    .append('text')
    .attr('class', 'country-label')
    .attr('x', d => d.x0 + 3)
    .attr('y', d => d.y0 + 13)
    .text(d => d.data.Entity || 'Unknown');

  }

  function updateLegend(minGDP, maxGDP) {
    // Remove previous legend items
    legendSvg.selectAll('*').remove();

    // Define the legend
    const legend = d3.legendColor()
      .shapeWidth(50) // Set the shape width to fill the space
      .shapeHeight(90) // Adjust shape height as needed
      .shapePadding(0) // No padding between shapes
      .labels(getLabels(thresholds, minGDP, maxGDP)) // Use custom labels
      .scale(colorScale);

    // Create a g element for the legend
    const legendGroup = legendSvg.append('g')
      .attr('class', 'legend')
      .attr('transform', 'translate(20, 20)');

    // Call the legend and render it
    legendGroup.call(legend);
  }

  // Helper function to format GDP values for legend labels
  function formatValue(value) {
    return value.toLocaleString('en-US', { maximumFractionDigits: 0 });
  }

  // Helper function to generate custom labels for the legend
  function getLabels(thresholds, minGDP, maxGDP) {
    const labels = [];
    const thresholdValues = [...thresholds, maxGDP]; // Include the maximum value

    for (let i = 0; i < thresholdValues.length; i++) {
      const currentValue = thresholdValues[i];
      const nextValue = thresholdValues[i + 1];

      if (i === 0) {
        labels.push(`â‰¥ $${formatValue(currentValue)}`);
      } else if (i === thresholdValues.length - 1) {
        labels.push(`< $${formatValue(currentValue)}`);
      } else {
        labels.push(`$${formatValue(currentValue)} - $${formatValue(nextValue - 1)}`);
      }
    }

    return labels;
  }

// Function to show tooltip and highlight the hovered node
function showTooltip(event, d) {
  const tooltip = d3.select('.legend-tooltip');
  const gdpPerCapita = d.data['GDP per capita'];
  const countryName = d.data.Entity;
  const year = d.data.Year;
  const tooltipContent = `Country: ${countryName}<br/>GDP Per Capita: $${gdpPerCapita}<br/>(International Rate in Year ${year})`;

  tooltip.html(tooltipContent)
    .style('display', 'block')
    .style('left', (event.pageX + 10) + 'px')
    .style('top', (event.pageY - 10) + 'px')
    .style('font-family', 'Arial, sans-serif')
    .style('font-weight', 'bold')
    .style('font-size', '14px')
    .style('color', '#333')
    .style('background-color', '#fff')
    .style('border', '1px solid #ccc')
    .style('border-radius', '5px')
    .style('padding', '10px')
    .style('box-shadow', '0 2px 4px rgba(0, 0, 0, 0.1)');
}

  // Function to move tooltip
  function moveTooltip(event) {
    const tooltip = d3.select('.legend-tooltip');
    tooltip.style('left', (event.pageX + 10) + 'px')
      .style('top', (event.pageY - 10) + 'px');
  }

  // Function to hide tooltip and remove highlight from the node
function hideTooltip() {
  const tooltip = d3.select('.legend-tooltip');
  tooltip.style('display', 'none');

  // Remove highlight from the node
  d3.select(this)
    .attr('stroke', 'none');
}

});

  </script>

</body>
</html>
